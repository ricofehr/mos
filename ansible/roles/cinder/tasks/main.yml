---

- name: Swap off
  shell: |
    swapoff -a
    sed -i 's/^.*swap.*$/#/g' /etc/fstab
  become: yes

- name: create cinder lvm
  shell: |
    disk="vda"
    if [[ -e /dev/vdb ]]; then
      disk="vdb"
    fi
    if [[ -e /dev/sdb ]]; then
      disk="sdb"
    fi
    if [[ -e /dev/nvme0 ]]; then
      disk="nvme0n1"
    fi
    pvcreate /dev/${disk}
    vgcreate cinder-volumes /dev/${disk}
    sed -i "s;# filter = .*/dev/cdrom.*$;filter = [ \"a/sda1/\", \"a/${disk}/\", \"r|.*/|\" ];" /etc/lvm/lvm.conf
    sed -i "s/use_lvmetad = 0/use_lvmetad = 1/" /etc/lvm/lvm.conf
  args:
    executable: /bin/bash
  become: yes

- name: Interface osstorage
  blockinfile:
    path: /etc/network/interfaces
    block: |
      # Container/Host management VLAN interface
      auto eth1.10
      iface eth1.10 inet manual
          vlan-raw-device eth1

      # OpenStack Networking VLAN interface for storage
      auto eth1.20
      iface eth1.20 inet manual
          vlan-raw-device eth1

      # Container/Host management bridge
      auto br-mgmt
      iface br-mgmt inet static
          bridge_stp off
          bridge_waitport 0
          bridge_fd 0
          bridge_ports eth1.10
          address 172.29.236.131/22

      # compute1 Storage bridge
      auto br-storage
      iface br-storage inet static
          bridge_stp off
          bridge_waitport 0
          bridge_fd 0
          bridge_ports eth1.20
          address 172.29.244.120/22
  become: yes

- name: Reboot
  shell: /sbin/shutdown -r +1
  async: 0
  poll: 0
  ignore_errors: true
  become: yes

- name: Ensure osstorage is up
  pause:
    minutes: 2

