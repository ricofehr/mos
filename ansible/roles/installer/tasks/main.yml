---

- name: Swap off
  shell: |
    swapoff -a
    sed -i 's/^.*swap.*$/#/g' /etc/fstab
  become: yes

- name: Network installer config
  shell: |
    DEBIAN_FRONTEND=noninteractive apt-get install -y --force-yes aptitude git ntp ntpdate openssh-server python-dev build-essential libpq-dev python-dev libpython-dev libxml2-dev libxslt1-dev libldap2-dev libsasl2-dev libffi-dev python-pip
    vconfig add eth1 10
    ip link set up eth1.10
    ip addr add 172.29.236.41 dev eth1.10
    route add -net 172.29.236.0/22 dev eth1.10
    route add -net 192.168.90.0/24 dev eth2
  become: yes

- name: Copy local vagrant private key file to osinstaller
  copy:
    src: ~/.vagrant.d/insecure_private_key
    dest: ~/.ssh/id_rsa
    mode: 0600
  become: yes

- name: Generate local vagrant public key file
  shell: cp /home/vagrant/.ssh/authorized_keys ~/.ssh/id_rsa.pub && chmod 0644 ~/.ssh/id_rsa.pub
  become: yes

- name: clone git repo
  shell: |
    git clone -b stable/stein https://git.openstack.org/openstack/openstack-ansible
  args:
    chdir: /opt
  become: yes

- name: bootstrap the osa project
  shell: |
    ./scripts/./bootstrap-ansible.sh >/tmp/logbootstrap 2>&1
    rsync -av etc/openstack_deploy /etc/
  args:
    chdir: /opt/openstack-ansible
  become: yes

- name: Default secrets
  shell: |
    pip install pyaml
    python pw-token-gen.py --file /etc/openstack_deploy/user_secrets.yml
    sed -i "s/keystone_auth_admin_password: .*$/keystone_auth_admin_password: toor/" /etc/openstack_deploy/user_secrets.yml
  args:
    chdir: /opt/openstack-ansible/scripts
  become: yes

- name: sync assets folder
  synchronize:
    src: assets/
    dest: assets/
  become: yes

- name: Override settings
  shell: |
    [[ -f openstack_user_config.yml ]] || cp -f openstack_user_config.yml.dist openstack_user_config.yml
    [[ -f user_variables.yml ]] || cp -f user_variables.yml.dist user_variables.yml
    [[ -f openstack_user_config.yml ]] && cp openstack_user_config.yml /etc/openstack_deploy/
    [[ -f user_variables.yml ]] && cp user_variables.yml /etc/openstack_deploy/
    [[ -d env.d ]] && rsync -av env.d/ /etc/openstack_deploy/env.d/
    sed -i "s/nova_virt_type:.*/nova_virt_type: {{ libvirt_driver }}/" /etc/openstack_deploy/user_variables.yml
  args:
    chdir: assets
    executable: /bin/bash
  become: yes

- name: Override settings, step 2
  shell: |
    [[ -f openstack_user_config.yml ]] || mv openstack_user_config.yml.test.example openstack_user_config.yml
    [[ -f user_variables.yml ]] || cp user_variables.yml.test.example user_variables.yml
  args:
    chdir: /etc/openstack_deploy
    executable: /bin/bash
  become: yes

- name: "Ensure infra1 is resolved into hosts file"
  lineinfile:
    dest: /etc/hosts
    line: "172.29.236.101 infra1"
    state: present
  with_items: "{{ ansible_play_hosts }}"
  when: hostvars[inventory_hostname]['ansible_host'] is defined
  become: yes

- name: Execute openstack-ansible setup-hosts
  shell: |
    openstack-ansible --ssh-extra-args="-C -o ControlMaster=auto -o ControlPersist=60s -o ConnectTimeout=30 -o ConnectionAttempts=5" setup-hosts.yml >/tmp/loghosts 2>&1
  args:
    chdir: /opt/openstack-ansible/playbooks
  become: yes

- name: Pause after setup hosts
  pause:
    minutes: 1

- name: Execute openstack-ansible setup-infra
  shell: |
    openstack-ansible --ssh-extra-args="-C -o ControlMaster=auto -o ControlPersist=60s -o ConnectTimeout=30 -o ConnectionAttempts=5" setup-infrastructure.yml >/tmp/loginfra 2>&1
  args:
    chdir: /opt/openstack-ansible/playbooks
  become: yes

- name: Pause after setup infra
  pause:
    minutes: 1

- name: Execute openstack-ansible setup-openstack
  shell: |
    openstack-ansible --ssh-extra-args="-C -o ControlMaster=auto -o ControlPersist=60s -o ConnectTimeout=30 -o ConnectionAttempts=5" setup-openstack.yml >/tmp/logos 2>&1
  args:
    executable: /bin/bash
    chdir: /opt/openstack-ansible/playbooks
  become: yes

- name: Pause after setup openstack
  pause:
    minutes: 1
